# 状态管理规则

本模块定义执行单元的状态管理和上下文切换规则。

---

## 核心规则

### 执行单元类型

```yaml
内部阶段: 需求评估、项目分析、方案设计、开发实施
路由级别: R0 直接响应、R1 快速流程、R2 简化流程、R3 标准流程
内部命令: ~auto, ~plan, ~exec, ~init, ~upgradekb, ~clean, ~cleanplan, ~commit, ~test, ~review, ~validatekb, ~rollback, ~rlm, ~status, ~help
外部工具: MCP服务器、子代理、插件、第三方Skill等
原子操作: 对话、咨询问答
```

### 命令触发状态设置

**状态变量定义:** [→ G6] 状态变量定义章节（单一事实来源，此处不重复）

**执行流程：** 路由匹配 → 命令确认 [→ G4] → 设置状态变量 → G7 加载规则 → 执行操作

**命令确认规则（CRITICAL）:**
```yaml
适用: 除豁免命令外的所有命令
时机: 可在命令输入后立即显示，也可在评估/分析后显示，但必须在实质性操作前
要求: 输出确认信息 → ⛔ END_TURN → 用户确认后才执行
最低选项: 继续 / 取消(→状态重置)
说明: 各命令可在确认中附加评估结果、范围选择、模式选择等信息
豁免: ~help、~status（只读状态查看）、~rlm/~rlm help（只读帮助信息）
```

---

## 阶段切换规则

| 切换路径 | 条件 |
|----------|------|
| 需求评估 → 级别判定 | 评估完成（R3 标准流程 需评分≥7） |
| 级别判定 → 对应级别 | 按 G4 通用路径级别判定 |
| 项目分析 → 方案设计 | 项目上下文已获取 |
| 方案设计 → 开发实施 | 方案包创建完成 |
| 开发实施 → 流程结束 | → 任务重置 |
| 外部工具 → 恢复 | → 状态重置后回到空状态 |

**否定/中断触发的切换:**
```yaml
否定信号: 清除当前状态 → 回到上层或空状态
中断信号: 暂存状态 → 处理新请求 → 提示恢复
```

---

## 模式切换协议

> 用户在确认阶段选择执行方式时的模式切换规则

| 用户选择 | 前提 | 动作 | 后续 |
|----------|------|------|------|
| 委托执行/委托规划 | DELEGATED/DELEGATED_PLAN | 保持 WORKFLOW_MODE | 按当前模式执行 |
| 交互式执行/交互式规划 | DELEGATED/DELEGATED_PLAN | WORKFLOW_MODE = INTERACTIVE | 每阶段输出并 ⛔ END_TURN |
| 确认开始 | INTERACTIVE | 保持 INTERACTIVE | 按交互模式执行 |

```yaml
切换时机: 仅在评估完成后的合并确认时
不可逆性: 一旦切换为 INTERACTIVE，当前流程内不会切回委托模式
手动切换: 取消后重新发起 ~auto/~plan 恢复委托模式
```

---

## 连续命令执行规则

```yaml
命令隔离: 每个命令独立执行单元，完成后 → 状态重置，新命令从干净状态开始

状态保持范围:
  跨命令保持: 全局配置、已创建文件和目录、知识库内容
  每命令重置: 见 G6 状态重置协议
```

### 命令互斥规则

| 类型 | 命令 | 规则 |
|------|------|------|
| 互斥 | ~auto, ~plan, ~exec, 自然语言工作流 | 同时只能执行一个 |
| 非互斥 | 独立工具命令（~init, ~upgradekb, ~clean, ~cleanplan, ~commit, ~test, ~review, ~validatekb, ~rollback, ~rlm）, ~help, ~status, 简单对话 | 可在流程中执行，不改变状态 |

**互斥处理:** 新命令输入时检测活动流程 → 询问取消 → 确认则 → 状态重置 → 执行新命令

---

## 异常处理

| 异常类型 | 处理 |
|----------|------|
| 状态变量设置失败 | 重新读取 → 重新设置 → 仍失败则输出错误 |
| 阶段切换中断 | 保持当前阶段 → 输出原因 → 提供继续/重试/取消选项 |
| 外部工具状态异常 | 检查上下文完整性 → 无法恢复则 → 状态重置 |
