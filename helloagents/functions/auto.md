# ~auto 命令 - 委托执行

本模块定义委托执行命令的规则。用户确认后，AI 自动推进所有阶段。

---

## 命令说明

```yaml
命令: ~auto [<需求描述>]
类型: 完整流程类
功能: 从需求评估到开发实施的完整流程
目标模式: DELEGATED（用户确认后生效）
```

**DO:** 完成评估后输出确认信息，用户确认后才设置 WORKFLOW_MODE，各阶段按 G9/G10 规则调用子代理

**DO NOT:** 跳过需求评估直接执行，用户确认前设置 WORKFLOW_MODE，用户确认前加载阶段模块，将确认视为可自动处理的决策点

---

## 回合A: 评估（收到 ~auto 命令时执行）

```yaml
当收到 ~auto [需求描述]:

  1. 设置 STAGE_ENTRY_MODE = NATURAL（WORKFLOW_MODE 暂不设置）
  2. 需求理解 + 评分 [→ G4 需求评估]

  评分 < 7 → 追问回合（按 {EVAL_MODE}）:
    输出追问信息 [→ G4 确认信息格式]
    ⛔ END_TURN（等待用户回复，用户回复后重新评分）

  评分 ≥ 7 → 确认回合:
    3. EHRB 检测 [→ G2]
    4. 输出确认信息 [→ G4 确认信息格式 / ~auto 选项]
    ⛔ END_TURN
```

---

## 回合B: 执行（用户确认后执行）

```yaml
当用户选择执行方式:

  委托执行:
    WORKFLOW_MODE = DELEGATED
    按 R3 标准流程进入阶段链（见下方"阶段路由"）

  交互式执行:
    WORKFLOW_MODE = INTERACTIVE
    按 R3 标准流程进入阶段链，每个阶段完成后 ⛔ END_TURN

  改需求:
    用户补充需求 → 回到回合A 重新评估

  取消:
    → 状态重置
```

### 阶段路由

```yaml
R3 标准流程阶段链:
  1. 加载 stages/analyze.md [阻塞式] → 项目分析
  2. 加载 stages/design.md [阻塞式] → 方案设计（含多方案对比）
  3. 加载 stages/develop.md [阻塞式] → 开发实施
  4. 验收: 按 G8 流程级验收规则执行
  5. 输出: 完成（验收报告+变更摘要+遗留提示）→ 状态重置
```

### DELEGATED 模式行为

```yaml
阶段间: 自动推进，不停顿
阶段内选择: 推荐选项自动选择
输出: 每个阶段仍输出摘要（禁止跳过输出）
overview 类型方案包: 直接归档，总结中标注
```

### INTERACTIVE 模式行为

```yaml
每个阶段完成后: 输出阶段摘要 → ⛔ END_TURN → 等待用户指令
阶段内选择: 输出选项 → ⛔ END_TURN → 等待用户选择
```

---

## 安全约束

```yaml
EHRB 检测始终生效，不受模式影响。

中断委托规则（DELEGATED 模式期间）:
  必须中断: EHRB 检测 | 阻断性测试失败 | 方案包验收失败（阻断性） | 无法解决的错误
  中断时: 设置 DELEGATION_INTERRUPTED = true → 输出问题详情和选项 → ⛔ END_TURN
  用户响应后:
    继续: DELEGATION_INTERRUPTED = false，恢复委托模式
    手动处理: WORKFLOW_MODE = INTERACTIVE
    取消: → 状态重置
```

---

## 不确定性处理

| 场景 | 处理 |
|------|------|
| 需求描述不完整 | 回合A 中按 G4 追问循环处理 |
| 级别难以判定 | 默认使用 R3 标准流程（~auto 强制 R3） |
| 方案选择冲突 | DELEGATED 模式下选择推荐方案 |
| 测试失败但非阻断性 | 记录到验收报告，继续执行 |
