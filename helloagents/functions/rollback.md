# ~rollback 命令 - 智能回滚

本模块定义回滚操作的执行规则。

---

## 命令说明

```yaml
命令: ~rollback
类型: 目标选择类
功能: 回滚变更，可选择回滚目标（版本/提交）
评估: 需求理解 + EHRB 检测（不评分不追问）
```

---

## 执行模式适配

```yaml
规则:
  1. 独立工具命令，不受 WORKFLOW_MODE 影响
  2. 回滚前必须创建备份
  3. EHRB 检测始终生效
  4. 必须用户确认回滚目标
```

---

## 执行流程

### 步骤1: 需求理解 + EHRB 检测

```yaml
无独立输出，直接进入下一步
```

### 步骤2: 扫描回滚来源

```yaml
前置条件（满足任一）:
  - 项目使用 Git 且有提交历史
  - archive/ 中存在可回滚的方案包
  - CHANGELOG.md 记录了版本历史

回滚来源分析（渐进式，优先使用 Git）:
  1. 检测 Git 提交历史（优先，通常足够）
  2. Git 不可用或信息不足时: 检查 archive/ 中可回滚的方案包
  3. 仍不足时: 分析 CHANGELOG.md 版本记录

展示:
  最多显示5个版本，含变更摘要和文件数，警告回滚影响

输出: 确认（回滚版本选择：可回滚版本+来源+当前状态）
⛔ END_TURN

用户确认后:
  选择版本N: → 步骤3
  取消: → 状态重置
```

### 步骤3: 执行回滚

```yaml
创建备份:
  Git仓库: 创建备份分支
  非Git: 复制文件到 backup/

执行回滚: 恢复代码文件 → 验证恢复结果

EHRB 触发时:
  输出: 警告（目标版本+影响范围+风险说明+备份策略）
  ⛔ END_TURN
  用户确认后:
    继续: 创建备份并执行（按 G2 记录到 CHANGELOG）
    取消: → 状态重置

回滚冲突:
  输出: 确认（冲突文件+详情+处理建议）
  ⛔ END_TURN
  用户确认后: 覆盖本地 / 保留本地 / 手动处理 / 取消: → 状态重置

同步知识库:
  CHANGELOG更新:
    格式: ### 回滚 → - **[{模块名}]**: 回滚至 {版本/提交} + 原因 + 方案包链接
    目录/文件创建: 按 G1 写入策略自动创建
  其他KB操作: 按 G1 KB_CREATE_MODE 行为执行
```

### 步骤4: 后续操作

```yaml
验收: 按 G8 命令级验收标准执行
  ⛔ 阻断性: 代码状态与目标版本一致（git status 无意外变更），目标提交正确
  ⚠️ 警告性: CHANGELOG 已更新

验收失败:
  阻断性: 输出: 警告，提示检查备份并手动恢复
  警告性: 记录到回滚报告

输出: 完成（验收报告+回滚结果）
→ 状态重置
```

---

## 安全约束

```yaml
强制约束:
  - 回滚前必须创建备份
  - EHRB 检测始终生效 [→ G2]
```

---

## 不确定性处理

| 场景 | 处理 |
|------|------|
| 无Git历史 | 使用方案包历史 |
| 全部不可用 | 输出: 错误，建议手动处理 |
| 回滚冲突 | 列出冲突文件，询问用户决定 |
