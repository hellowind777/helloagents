# ~init 命令 - 初始化知识库

本模块定义知识库初始化的执行规则。

---

## 命令说明

```yaml
命令: ~init
类型: 场景确认类
功能: 扫描代码库创建知识库
评估: 需求理解 + EHRB 检测（不评分不追问）
```

---

## 执行模式适配

```yaml
规则:
  1. 独立工具命令，不受 WORKFLOW_MODE 影响
  2. KB_CREATE_MODE=0 时需用户确认后执行
  3. 知识库已存在时需用户确认重建或升级
  4. 大型项目启用分批处理
```

---

## 执行流程

### 步骤1: 需求理解 + EHRB 检测

```yaml
无独立输出，直接进入下一步
```

### 步骤2: 扫描与检测

```yaml
知识库开关检查:
  KB_CREATE_MODE=0: 输出: 确认（开关状态）
    ⛔ END_TURN
    用户确认后:
      继续: 继续下方流程
      取消: → 状态重置
  KB_CREATE_MODE=1/2/3: 直接继续

知识库状态检测:
  0. 旧目录名迁移检测:
     脚本: upgradewiki.py --migrate-root
     status=migrated → 提示已自动迁移 helloagents/ → .helloagents/，继续
     status=conflict → 输出: 确认（新旧目录同时存在）→ 用户选择保留哪个 → ⛔ END_TURN
     status=not_needed/not_found → 静默继续
  1. 检查 {KB_ROOT}/ 目录是否存在
  2. 检查核心文件完整性（INDEX.md, context.md, CHANGELOG.md, modules/_index.md）
  3. 对比当前结构与框架标准
  4. 判定处理路径:
```

| 状态 | 处理 |
|------|------|
| 不存在 | 输出: 确认（项目信息+将创建知识库）→ 继续(→步骤3) / 取消(→状态重置) |
| 存在但结构不匹配 | 输出: 确认 → 升级(→upgradekb.md) / 重建(→步骤3) / 取消(→状态重置) |
| 存在但不完整 | 输出: 确认（缺失文件列表）→ 补全 / 重建(→步骤3) / 取消(→状态重置) |
| 存在且完整 | 输出: 确认（重建）→ 重建(删除后→步骤3) / 取消(→状态重置) |

### 步骤3: 创建知识库文件

```yaml
扫描代码库:
  优先: 根目录配置文件（package.json/pyproject.toml/Cargo.toml/pom.xml 等）
  按需: 配置文件信息不足时，再扫描目录结构和源代码文件

技术栈识别:
  1. 读取根目录包管理/构建配置文件（优先，通常足够确定技术栈）
  2. 信息不足时: 检查框架特征文件、分析源代码文件扩展名
  无法确定: 标注"未识别"，建议用户补充

按需提取: 技术栈 + 模块结构 + 与当前项目相关的接口和数据模型

创建:
  目录结构: 按 G1 知识库完整结构创建（含 sessions/ 目录）
  模板: 读取 services/templates.md
  大型项目: 按 G9 复杂度判定标准（TASK_COMPLEXITY=complex）分批处理
  全局记忆: 检查 {HELLOAGENTS_ROOT}/user/ 目录，不存在时自动创建
```

### 步骤4: CLI 环境配置

```yaml
Codex CLI 配置（自动检测，非 Codex 环境跳过）:
  脚本: configure_codex.py
  功能: 设置 project_doc_max_bytes = 98304（96 KiB），防止规则文件被截断
  安全: 仅在参数未设置或低于目标值时写入，不修改已有配置
```

### 步骤5: 后续操作

```yaml
验证:
  完整性: 核心文件存在且非空，模块覆盖完整
  安全性: 无敏感信息泄露
  格式: Markdown 格式正确，Mermaid 图表可渲染

输出: 完成（初始化结果）
→ 状态重置
```

---

## 不确定性处理

| 场景 | 处理 |
|------|------|
| 空项目（无源代码） | 输出: 错误，建议确认目录 |
| 权限不足 | 输出: 错误，建议检查权限 |
| 扫描超时（大型项目） | 分批处理，输出进度提示 |
| 无法识别项目类型 | 询问用户提供技术栈信息 |
