# ~plan 命令 - 委托规划

本模块定义委托规划命令的规则。用户确认后，AI 自动推进到方案设计完成为止（不进入开发实施）。

---

## 命令说明

```yaml
命令: ~plan [<需求描述>]
类型: 完整流程类
功能: 从需求评估执行到方案设计后停止
目标模式: DELEGATED_PLAN（用户确认后生效）
```

**DO:** 完成评估后输出确认信息，方案设计完成后终止流程

**DO NOT:** 跳过需求评估直接进入方案设计，用户确认前设置 WORKFLOW_MODE，方案设计完成后继续进入开发实施

---

## 回合A: 评估（收到 ~plan 命令时执行）

```yaml
当收到 ~plan [需求描述]:

  1. 设置 STAGE_ENTRY_MODE = NATURAL（WORKFLOW_MODE 暂不设置）
  2. 需求理解 + 评分 [→ G4 需求评估]

  评分 < 7 → 追问回合（按 {EVAL_MODE}）:
    输出追问信息 [→ G4 确认信息格式]
    ⛔ END_TURN（等待用户回复，用户回复后重新评分）

  评分 ≥ 7 → 确认回合:
    3. EHRB 检测 [→ G2]
    4. 输出确认信息 [→ G4 确认信息格式 / ~plan 选项]
    ⛔ END_TURN
```

---

## 回合B: 执行（用户确认后执行）

```yaml
当用户选择执行方式:

  委托规划:
    WORKFLOW_MODE = DELEGATED_PLAN
    按 R3 标准流程进入阶段链（见下方"阶段路由"）

  交互式规划:
    WORKFLOW_MODE = INTERACTIVE
    按 R3 标准流程进入阶段链，每个阶段完成后 ⛔ END_TURN

  改需求:
    用户补充需求 → 回到回合A 重新评估

  取消:
    → 状态重置
```

### 阶段路由

```yaml
R3 标准流程阶段链:
  1. 加载 stages/analyze.md [阻塞式] → 项目分析
  2. 加载 stages/design.md [阻塞式] → 方案设计（含多方案对比）
  3. 验收: 按 G8 流程级验收规则执行
  4. 输出: 完成（验收报告+方案包摘要）→ 状态重置
  流程终止（不进入开发实施）
```

### R1 级别任务处理

```yaml
当评估后发现任务实际为 R1 级别:
  输出提示 + 选项:
    1. 直接执行（推荐）: WORKFLOW_MODE = INTERACTIVE → 按 G4 R1 快速流程执行 → 完成 → 状态重置
    2. 强制规划: 升级为 R2 简化流程 → 按阶段路由执行
    3. 取消: → 状态重置

  ⛔ END_TURN
```

---

## 不确定性处理

| 场景 | 处理 |
|------|------|
| 需求描述不完整 | 回合A 中按 G4 追问循环处理 |
| 评估后发现为 R1 级别 | 提示用户选择直接执行或强制规划 |
| 方案设计无法完成 | 输出已完成部分，标注待定项 |
