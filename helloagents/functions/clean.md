# ~clean 命令 - 清理会话记录

本模块定义清理会话摘要（L2）和用户记忆（L0）的执行规则。

---

## 命令说明

```yaml
命令: ~clean [范围]
类型: 场景确认类
功能: 清理会话摘要文件和/或用户记忆，支持按时间、名称、列表清理
评估: 需求理解 + EHRB 检测（不评分不追问）
```

---

## 执行流程

### 步骤1: 需求理解 + EHRB 检测

```yaml
无独立输出，直接进入下一步
```

### 步骤2: 解析参数与扫描

```yaml
前置迁移: upgradewiki.py --migrate-root（静默执行，确保旧目录名已迁移后再扫描）

参数解析:
  ~clean              → 列出所有可清理项，让用户选择
  ~clean sessions     → 清理会话摘要（L2），展示列表供选择
  ~clean sessions all → 清理全部会话摘要（需确认）
  ~clean sessions 7d  → 清理 7 天前的会话摘要
  ~clean memory       → 清理用户记忆（L0），展示条目供选择
  ~clean memory all   → 清空全部用户记忆（需确认）
  ~clean all          → 清理全部 L0 + L2（需二次确认）

扫描目录:
  会话摘要（L2）:
    项目级: {KB_ROOT}/sessions/*.md
    全局级: {HELLOAGENTS_ROOT}/user/sessions/*.md
  用户记忆（L0）:
    文件: {HELLOAGENTS_ROOT}/user/profile.md

无文件: 输出: 完成（提示无记录需要清理），流程结束

有文件:
  展示: 清理目标列表（类型、名称/ID、时间、摘要首行）
  输出: 确认（清理范围）
  ⛔ END_TURN
  用户确认后: 继续 / 重新选择 / 取消: → 状态重置
```

### 步骤3: 执行清理

```yaml
用户确认后执行:
  L2: 删除目标 .md 文件
  L0: 移除目标条目或清空文件
用户取消: 不做操作 → 状态重置

输出: 完成（已清理数量 + 剩余数量）
→ 状态重置
```

---

## 不确定性处理

| 场景 | 处理 |
|------|------|
| sessions/ 目录不存在 | 提示无会话记录 |
| profile.md 不存在 | 提示无用户记忆 |
| 当前活跃会话 | 跳过，提示不可清理进行中的会话 |
| 时间参数格式错误 | 提示正确格式（如 7d, 30d, 3m） |
