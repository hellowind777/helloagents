# ~cleanplan 命令 - 清理遗留方案

本模块定义清理遗留方案包的执行规则。

---

## 命令说明

```yaml
命令: ~cleanplan
类型: 场景确认类
功能: 清理 plan/ 目录中的遗留方案包，列出方案包让用户选择清理范围
评估: 需求理解 + EHRB 检测（不评分不追问）
```

---

## 执行模式适配

```yaml
规则:
  1. 独立工具命令，不受 WORKFLOW_MODE 影响
  2. 清理操作需用户确认范围（全部/选择性）
  3. 方案包迁移至 archive/ 而非直接删除
  4. 迁移时标记状态为 skipped
```

---

## 执行流程

### 步骤1: 需求理解 + EHRB 检测

```yaml
无独立输出，直接进入下一步
```

### 步骤2: 扫描方案包

```yaml
前置迁移: upgradewiki.py --migrate-root（静默执行，确保旧目录名已迁移后再扫描）
前置: plan/ 目录存在至少一个方案包

脚本: list_packages.py
无方案包: 输出: 完成（提示无需清理），流程结束

有方案包:
  展示: 方案包列表（名称、创建时间、类型）
  输出: 确认（遗留方案包清理）
  ⛔ END_TURN
  用户确认后: 全部清理 / 选择性清理 / 取消(→状态重置)
```

### 步骤3: 执行迁移

```yaml
脚本: migrate_package.py <package-name> --status skipped
  --all 迁移全部

脚本执行报告:
  success=true: 继续步骤4验收
  success=false: 按 rules/tools.md AI降级接手流程处理
    质量检查 completed 步骤:
      验证方案包存在 → 创建归档目录 → 更新 tasks.md 状态 → 移动方案包 → 更新 _index.md
    发现问题: 修复
    按 pending 列表继续完成
```

### 步骤4: 后续操作

```yaml
验收: 按 G8 命令级验收标准执行
  ℹ️ 信息性: 目标方案包已迁移（plan/ → archive/）
  ⚠️ 警告性: 无误删重要文件

验收失败:
  警告性: 记录到清理报告，提示检查 archive/

输出: 完成（验收报告+已迁移清单+plan/状态）
→ 状态重置
```

---

## 不确定性处理

| 场景 | 处理 |
|------|------|
| plan/ 目录不存在 | 输出: 完成，提示无需清理 |
| 方案包迁移失败 | 报告失败项，继续处理其他方案包 |
| archive/ 目录不存在 | 创建后继续 |
