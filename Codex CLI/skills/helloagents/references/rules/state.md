# 状态管理规则

本模块定义执行单元的状态管理和上下文切换规则。

---

## 规则概述

> 📌 规则引用:
> - 状态变量定义（取值、含义）见 G6 "状态变量定义"
> - 状态重置协议见 G6 "状态重置协议"
> - 外部工具规则见 G4 Layer 2
> - 命令分类见 G4 Layer 2 "命令分类"

```yaml
规则名称: 状态管理规则
适用范围: 所有命令触发和阶段流转场景
核心职责:
  - 定义执行单元类型和上下文边界
  - 管理模式切换协议
  - 管理连续命令执行规则
```

---

<state_management>
## 核心规则

### 执行单元类型

```yaml
内部阶段: 需求评估、项目分析、方案设计、开发实施、微调模式、轻量迭代、标准开发
内部命令: ~auto, ~plan, ~exec, ~init, ~upgrade, ~clean, ~help...
外部工具: MCP服务器、子代理、插件、第三方Skill等
原子操作: 对话、咨询问答
```

### 命令触发状态设置

> 📌 命令分类和状态设置动作见 G4 Layer 2 "命令分类"，模块加载规则见 G7

**执行流程：**
```
路由匹配 → 命令确认 → 设置状态变量 → 按 G7 加载规则 → 执行操作
```
</state_management>

---

<stage_transition>
## 阶段流转规则

> 📌 规则引用: 执行模式和处理路径见 G5，阶段闸门见 G8

```yaml
流转概要:
  需求评估 → 复杂度判定: 评分≥7分
  复杂度判定 → 对应模式: 按 G4 复杂度判定规则
  项目分析 → 方案设计: 项目上下文已获取
  方案设计 → 开发实施: 方案包创建完成
  开发实施 → 流程结束: 按 G6 状态重置协议
  外部工具 → 恢复: 按 G4 外部工具规则
```
</stage_transition>

---

<mode_switch>
## 模式切换协议

> 定义用户在确认阶段选择执行方式时的模式切换规则

### 触发场景

```yaml
场景: 需求评估阶段的复杂度判定确认
前提: WORKFLOW_MODE = AUTO_FULL 或 AUTO_PLAN（~auto/~plan命令触发）
触发: 用户在确认选项中选择"交互执行"
```

### 切换规则

```yaml
用户选择"确认执行（静默）":
  动作: 保持当前 WORKFLOW_MODE 不变
  后续: 按当前模式静默执行
    - AUTO_FULL: 静默执行直到流程完成
    - AUTO_PLAN: 静默执行直到方案设计完成

用户选择"交互执行":
  动作: 设置 WORKFLOW_MODE = INTERACTIVE
  后续: 切换为交互模式，每阶段输出结果并等待确认
  注意: 此选项仅在 AUTO_FULL/AUTO_PLAN 模式下可用

用户选择"确认开始"（仅INTERACTIVE模式）:
  动作: 保持 WORKFLOW_MODE = INTERACTIVE
  后续: 按交互模式执行，每阶段交互
```

### 模式切换时机

```yaml
切换点: 仅在需求评估阶段的复杂度判定确认时
不可逆性: 一旦切换为INTERACTIVE，当前流程内不会自动切回AUTO模式
手动切换: 用户可通过取消后重新发起~auto/~plan命令来恢复自动模式
```
</mode_switch>

---

<consecutive_commands>
## 连续命令执行规则

> 定义用户连续执行多个命令时的状态管理边界

### 核心原则

> 📌 规则引用: 状态重置协议见 G6 "状态重置协议"

```yaml
命令隔离原则:
  - 每个命令是独立的执行单元
  - 前一个命令完成后，按 G6 状态重置协议执行
  - 新命令从干净状态开始执行
  - 禁止依赖前一个命令的临时状态

状态保持范围:
  保持（跨命令）: 全局配置、已创建的文件和目录、知识库内容
  重置（每个命令独立）: 见 G6 状态重置协议
```

### 连续命令场景

```yaml
核心规则:
  - 命令完成/取消后: 状态重置 → IDLE → 新命令从干净状态开始
  - 流程命令互斥: ~auto/~plan/~exec 同时只能执行一个
  - 原子命令可嵌入: ~help/~validate 不影响当前流程状态
  - 对话不产生状态: 自然对话后系统处于 IDLE 状态
```

### 命令互斥规则

```yaml
互斥命令组（同时只能执行一个）:
  - ~auto
  - ~plan
  - ~exec
  - 自然语言触发的完整工作流

互斥处理:
  新命令输入时检测:
    当前有活动流程命令 → 询问用户是否取消当前命令
    用户确认取消 → 执行状态重置 → 执行新命令
    用户拒绝取消 → 继续当前命令

非互斥命令（可在流程中执行）:
  - ~help: 查看帮助，不改变状态
  - ~validate: 验证操作，只读
  - 简单对话: 不改变流程状态
```
</consecutive_commands>

---

## 异常处理

```yaml
状态变量设置失败:
  - 重新读取当前状态
  - 按命令类型重新设置
  - 仍失败则输出错误，建议用户重新输入命令

阶段流转中断:
  - 保持当前阶段状态
  - 输出中断原因
  - 提供恢复选项（继续/重试/取消）

外部工具状态隔离失败:
  - 按 G4 外部工具规则尝试恢复
  - 无法恢复时清除工具状态
  - 提示用户当前状态
```

---

## 规则引用关系

```yaml
被引用:
  - 所有~命令（状态设置）
  - 所有阶段模块（阶段流转）
  - G4 路由架构（含需求评估规则、模式切换协议）

引用:
  - G5 执行模式规则（处理路径）
  - G4 外部工具规则
  - G6 状态变量定义
  - G6 状态重置协议
  - G6 模块加载表
```
