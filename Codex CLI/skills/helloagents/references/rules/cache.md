# KV 缓存优化规则

---

## Append-Only 规则

```yaml
tasks.md:
  执行: 更新任务状态符号，追加执行日志
  禁止: 重写整个任务列表

知识库:
  执行: 追加变更记录到 CHANGELOG
  禁止: 频繁重写模块文档

响应:
  执行: 进度快照追加在响应末尾
  禁止: 在响应中间插入状态信息
```

---

## 上下文分层

```yaml
Layer 0 - 系统指令: 核心规则、角色预设
Layer 1 - 项目上下文: 知识库内容、项目结构
Layer 2 - 会话上下文: 当前方案包、任务状态
Layer 3 - 即时信息: 用户消息、执行结果、进度快照

加载规则:
  - 阶段模块: 进入阶段时加载
  - 知识库详情: 需要时读取
  - 子代理规则: 调用时加载
  - 大文件: 分块读取

卸载规则:
  - 完成的阶段模块可移除
  - 归档的方案包信息可精简
```

---

## 前缀稳定规则

```yaml
保护内容:
  - 核心规则（G1-G12）
  - 当前阶段模块
  - 项目上下文摘要

禁止操作:
  - 在会话中重写系统指令
  - 频繁切换阶段模块

tasks.md 更新:
  1. 定位目标任务行
  2. 仅修改状态符号（[ ] → [√]）
  3. 在执行日志末尾追加记录
  4. 更新进度概览统计

知识库更新:
  1. CHANGELOG 采用追加模式
  2. 模块文档采用增量编辑
  3. 避免整体重写
```

---

## 子代理上下文隔离

```yaml
主代理 → 子代理:
  传递:
    - 任务描述
    - 必要的项目上下文
    - 相关文件路径
  禁止传递:
    - 完整的主配置文件
    - 无关的历史对话
    - 其他子代理的结果

子代理 → 主代理:
  返回:
    - 结构化的执行结果（JSON）
    - 关键发现摘要
    - 修改的文件列表
  禁止返回:
    - 完整的文件内容
    - 冗长的中间步骤
    - 重复的上下文信息
```

---

## 长会话处理

```yaml
压缩触发:
  - 上下文接近模型限制（80%）
  - 会话轮次超过阈值
  - 显式请求压缩

压缩规则:
  保留: 系统指令、当前任务、最近错误
  压缩: 历史对话、已完成任务详情
  移除: 重复信息、过时状态

恢复流程:
  1. 读取 tasks.md 获取当前状态
  2. 读取最近的执行日志
  3. 加载必要的项目上下文
  4. 从中断点继续执行
```

---

## 禁止操作

```yaml
- 每次更新都重写整个文件 → 使用增量编辑
- 不断追加信息不做清理 → 定期压缩，移除过时信息
- 动态信息插入稳定层 → 动态信息置于末尾
- 子代理结果包含完整上下文 → 仅返回结构化结果
```

---

## 引用

| 规则 | 定义位置 |
|------|---------|
| 进度快照 | references/services/attention.md |
| 任务状态符号 | G6 |
| 子代理编排 | G9 |
| 阶段模块 | references/stages/*.md |
