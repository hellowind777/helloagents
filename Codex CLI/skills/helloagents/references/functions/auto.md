# ~auto 命令 - 全授权命令

本模块定义全授权命令的执行规则。

---

## 命令说明

```yaml
命令: ~auto [<需求描述>]
类型: 完整流程类
功能: 全授权命令，从需求评估到开发实施，评估需求完整性后进入对应执行模式
模式: WORKFLOW_MODE = AUTO_FULL
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~auto 模式适配规则:
1. 本命令固定使用 AUTO_FULL 模式
2. 评估深度: 完整评估（含评分追问）
3. 静默模式下自动处理所有决策点
4. 交互模式下每阶段需用户确认
5. EHRB 检测始终生效，不受模式影响
6. 各阶段自动按需调用子代理（按 G9/G10 规则）
</mode_adaptation>

---

## 执行流程

### 步骤1: 需求评估

```yaml
设置状态变量:
  - WORKFLOW_MODE = AUTO_FULL
  - STAGE_ENTRY_MODE = NATURAL

执行规则: 按 G4 "需求评估规则"执行（完整评估+复杂度判定），按G3场景内容规则（需求评估/复杂度判定场景）输出
```

### 步骤2: 执行对应模式

```yaml
根据复杂度判定结果:
  微调模式: 读取并执行 references/stages/tweak.md
  轻量迭代/标准开发: 进入步骤3
```

### 步骤3: 项目分析（仅轻量迭代/标准开发）

```yaml
执行规则: 读取并执行 references/stages/analyze.md

静默模式: 不输出
交互模式: 输出阶段完成提示
```

### 步骤4: 方案设计

```yaml
执行规则: 读取并执行 references/stages/design.md

复杂任务: 静默模式下自动选择推荐方案
简单任务: 静默模式下自动确定方案
overview 类型: 归档至 archive/，跳过开发实施

设置: CREATED_PACKAGE = 本次创建的方案包路径
```

### 步骤5: 开发实施

```yaml
执行规则: 读取并执行 references/stages/develop.md

静默模式: 执行所有任务，质量问题在总结中列出
交互模式: 每个任务完成后提示
```

### 步骤6: 后续操作

```yaml
执行规则: 按 G8 "流程级验收规则" 执行（验收内容详见 G8）

遗留方案包扫描:
  执行规则: 按 G6 "遗留方案包扫描" 执行
  扫描时机: 流程即将结束时
  显示条件: 检测到≥1个遗留方案包
  详细规则: 参考 references/services/package.md "遗留方案包处理"

完成后: 按G3场景内容规则（完成场景）输出全授权命令结果（含验收报告）
执行: 按 G6 状态重置协议执行
```

---

## 安全约束

> 📌 规则引用: 按 G2 EHRB 检测规则执行

```yaml
强制约束:
  - EHRB 检测始终生效，检测到时必须打破静默
  - 阻断性测试失败必须中断静默模式
  - 方案包验收失败（阻断性）必须用户确认
```

### 打破静默规则

```yaml
适用时机: 用户选择确认执行后进入静默模式期间

必须打破静默的情况:
  - 检测到 EHRB（极度高风险行为）
  - 阻断性测试失败
  - 方案包验收失败（阻断性）
  - 无法自动解决的错误

用户响应后:
  - 有效输入: 恢复静默，继续执行
  - "取消": 按 G6 状态重置协议执行
```

---

## 不确定性处理

- 需求描述不完整 → 按 G4 需求评估追问循环处理
- 复杂度难以判定 → 默认使用轻量迭代模式
- 方案选择冲突 → 静默模式下选择推荐方案
- 测试失败但非阻断性 → 记录到验收报告，继续执行

---

## 用户选择处理

> 本章节定义 ~auto 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 执行模式确认（需求评估完成后）

```yaml
触发条件: WORKFLOW_MODE = AUTO_FULL（~auto命令触发）

内容要素: 按 G4 "复杂度判定确认"场景，额外包含:
  - 执行方式说明（静默执行 vs 交互执行的区别）
  - 预计影响范围

选项: 按 G4 "复杂度判定确认"场景（AUTO_FULL/AUTO_PLAN模式）

状态变更: 按 references/rules/state.md "模式切换协议"执行
```

### 场景: 打破静默确认

```yaml
内容要素:
  - 打破静默原因（EHRB/测试失败/方案包验收失败/无法解决的错误）
  - 问题详情描述
  - 建议的处理方式

选项:
  继续执行: 恢复静默，继续执行
  手动处理: 暂停静默，用户介入处理
  取消: 按 G6 状态重置协议执行
```

### 场景: 流程级验收完成

```yaml
内容要素:
  - 验收状态: 通过/部分通过/失败
  - 交付物摘要: 方案包、代码变更、知识库状态
  - 需求符合性: 已完成项/未完成项
  - 问题汇总: 警告和信息性记录（如有）

输出格式: 按G3场景内容规则（完成场景）输出
```
