# ~review 命令 - 代码审查

本模块定义代码审查的执行规则。

---

## 命令说明

```yaml
命令: ~review [<路径>]
类型: 范围选择类
功能: 按照执行流程进行代码审查，可选择审查范围（全部代码/最近修改/暂存区/指定路径）
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~review 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 评估深度: 轻量评估（无评分追问）
3. 无参数时需用户选择审查范围
4. 审查结果按严重程度分级
5. 发现问题时提供优化方案选项
6. 大范围审查自动调用 reviewer 子代理（按 G9/G10 规则）
</mode_adaptation>

---

## 执行流程

### 步骤1: 轻量评估

```yaml
执行规则: 按 G4 "需求评估规则"执行（轻量评估），按G3场景内容规则（需求评估场景）输出
```

### 步骤2: 确定审查范围

```yaml
执行内容:
  - 无参数时询问用户选择范围
  - 支持: 全部代码/最近修改/暂存区/指定路径

按G3场景内容规则（确认场景）输出，见"用户选择处理 - 审查范围选择"
```

### 步骤3: 执行审查

<code_quality_check>
代码质量分析步骤:
1. 评估代码复杂度（函数长度、嵌套层级、圈复杂度）
2. 检测代码重复度和命名规范一致性
3. 分析注释覆盖率和文档完整性
4. 识别不安全函数使用和敏感信息硬编码
5. 检测注入风险（SQL/命令/XSS）和低效算法模式
6. 按严重程度分级问题并提供修复建议
</code_quality_check>

```yaml
分析维度:
  质量: 代码复杂度、重复度、命名规范、注释覆盖率
  安全: 不安全函数、敏感信息硬编码、注入风险
  性能: 低效算法模式、资源泄漏风险

输出报告:
  - 按严重程度分级（Critical/Warning/Info）
  - 提供文件路径、行号、修复建议
```

### 步骤4: 后续操作

```yaml
有问题时: 按G3场景内容规则（确认场景）输出，见"用户选择处理 - 代码审查结果处理"

目录/文件创建: 按 G1 "目录/文件自动创建规则" 执行

完成后: 按 G6 状态重置协议执行
```

---

## 分析原则

```yaml
审查策略:
  - 测试文件降低安全检查严格度
  - 生成的代码/压缩代码跳过审查
  - 框架特定代码参考框架最佳实践
  - 复杂度难以判定时标注"需人工审查"
```

---

## 不确定性处理

- 文件类型无法识别 → 跳过审查，标注"未知类型"
- 复杂度难以判定 → 标注"需人工审查"
- 审查范围过大 → 建议缩小范围或分批审查

---

## 用户选择处理

### 场景: 审查范围选择（无参数时）

```yaml
内容要素:
  - 可选审查范围: 全部代码/最近修改/暂存区/指定路径
  - 各范围的说明和适用场景

选项:
  全部代码: 审查整个代码库
  最近修改: 仅审查最近修改的文件
  暂存区: 仅审查 Git 暂存区的文件
  指定路径: 用户输入具体路径
  取消: 按 G6 状态重置协议执行
```

### 场景: 代码审查结果处理

```yaml
内容要素:
  - 审查结果摘要（按严重程度分级）
  - 问题列表（Critical/Warning/Info）
  - 关键问题的文件路径和行号

选项:
  生成优化方案: 创建 plan/YYYYMMDDHHMM_code-review/ 方案包
  仅记录报告: 输出完整报告
  跳过: 不执行操作
```
