# ~review 命令 - 代码审查

本模块定义代码审查的执行规则。

---

## 命令说明

```yaml
命令: ~review [<路径>]
类型: 范围选择类
功能: AI辅助代码审查，必须选择审查范围（全部代码/最近修改/暂存区/指定路径）
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~review 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 无参数时需用户选择审查范围
3. 审查结果按严重程度分级
4. 发现问题时提供优化方案选项
5. 大范围审查自动调用 reviewer 子代理（按 G8/G9 规则）
</mode_adaptation>

---

## 子代理自动调用

> 📌 规则引用: 按 G8 "子代理编排" + G9 "跨CLI兼容规则" 执行

```yaml
调用原则:
  - 满足触发条件时自动调用，无需用户干预
  - 子代理结果自动折叠后返回主流程

reviewer 子代理调用条件:
  - 审查范围涉及 ≥ 5 个文件
  - 审查范围总代码行数 > 500 行
  - 审查涉及核心模块或安全相关代码

执行方式:
  - 通过 Task 工具启动 reviewer 子代理
  - 子代理专注代码质量分析
  - 结果汇总后返回主流程输出
```

---

## 执行流程

### 步骤1: 确定审查范围

```yaml
执行内容:
  - 无参数时询问用户选择范围
  - 支持: 全部代码/最近修改/暂存区/指定路径

按 G3 场景内容规则（确认）输出，见"用户选择处理 - 审查范围选择"
```

### 步骤2: 代码分析

<code_quality_analysis>
代码质量分析推理过程:
1. 评估代码复杂度（函数长度、嵌套层级、圈复杂度）
2. 检测代码重复度和命名规范一致性
3. 分析注释覆盖率和文档完整性
4. 识别不安全函数使用和敏感信息硬编码
5. 检测注入风险（SQL/命令/XSS）和低效算法模式
6. 按严重程度分级问题并提供修复建议
</code_quality_analysis>

```yaml
质量维度:
  - 代码复杂度（函数长度、嵌套层级）
  - 代码重复度
  - 命名规范一致性
  - 注释覆盖率

安全维度:
  - 不安全函数使用
  - 敏感信息硬编码
  - 注入风险（SQL/命令/XSS）

性能维度:
  - 低效算法模式
  - 资源泄漏风险
```

### 步骤3: 生成报告

```yaml
执行内容:
  - 按严重程度分级（Critical/Warning/Info）
  - 提供文件路径、行号、修复建议
```

### 步骤4: 后续操作

```yaml
有问题时:
  按 G3 场景内容规则（确认）输出，见"用户选择处理 - 代码审查结果处理"
  [等待用户响应]
  用户选择后按对应选项处理

目录/文件创建: 按 G1 "目录/文件自动创建规则" 执行

完成后: 按 G6 状态重置协议执行
```

---

## 分析原则

```yaml
审查策略:
  - 测试文件降低安全检查严格度
  - 生成的代码/压缩代码跳过审查
  - 框架特定代码参考框架最佳实践
  - 复杂度难以判定时标注"需人工审查"
```

---

## 不确定性处理

- 文件类型无法识别 → 跳过审查，标注"未知类型"
- 复杂度难以判定 → 标注"需人工审查"
- 审查范围过大 → 建议缩小范围或分批审查

---

## 用户选择处理

> 本章节定义 ~review 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 审查范围选择（无参数时）

```yaml
内容要素:
  - 可选审查范围: 全部代码/最近修改/暂存区/指定路径
  - 各范围的说明和适用场景

选项:
  全部代码: 审查整个代码库
  最近修改: 仅审查最近修改的文件
  暂存区: 仅审查 Git 暂存区的文件
  指定路径: 用户输入具体路径
  取消: 按 G6 状态重置协议执行
```

### 场景: 代码审查结果处理

```yaml
内容要素:
  - 审查结果摘要（按严重程度分级）
  - 问题列表（Critical/Warning/Info）
  - 关键问题的文件路径和行号

选项:
  生成优化方案: 创建 plan/YYYYMMDDHHMM_code-review/ 方案包
  仅记录报告: 输出完整报告
  跳过: 不执行操作
```
