# ~test 命令 - 运行测试

本模块定义运行测试的执行规则。

---

## 命令说明

```yaml
命令: ~test
类型: 场景确认类
功能: 按照执行流程检测框架运行测试并分析结果
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~test 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 评估深度: 轻量评估（无评分追问）
3. 自动检测测试框架，多框架时需用户选择
4. 无法检测时请求用户提供测试命令
5. 测试失败时提供修复方案选项
6. 需要设计新测试用例时自动调用 tester 子代理（按 G9/G10 规则）
</mode_adaptation>

---

## 执行流程

### 步骤1: 轻量评估

```yaml
执行规则: 按 G4 "需求评估规则"执行（轻量评估），按G3场景内容规则（需求评估场景）输出
```

### 步骤2: 扫描测试环境

```yaml
执行内容:
  - 扫描项目配置文件识别测试框架
  - 扫描常见测试目录和文件
  - 匹配测试文件命名模式

多框架共存时: 询问用户选择
无法检测时: 请求用户提供测试命令

按G3场景内容规则（确认场景）输出
```

### 步骤3: 执行测试

<test_result_check>
测试结果分析步骤:
1. 解析测试输出获取通过/失败/跳过统计
2. 提取失败测试的文件路径和行号
3. 分析错误信息确定失败原因
4. 判断是否为阻断性测试失败
5. 生成修复建议
</test_result_check>

```yaml
执行内容:
  - 执行测试命令（带超时保护）
  - 捕获输出和退出码
  - 解析通过/失败/跳过统计
  - 提取失败测试的文件路径和行号
  - 提取错误摘要

输出: 按 Shell 包装规则输出结果
```

### 步骤4: 后续操作

```yaml
输出: 按 Shell 包装规则输出结果

有失败时: 按G3场景内容规则（确认场景）输出，见"用户选择处理 - 测试失败处理"

目录/文件创建: 按 G1 "目录/文件自动创建规则" 执行

完成后: 按 G6 状态重置协议执行
```

---

## 不确定性处理

- 无法检测框架 → 询问用户提供测试命令
- 多框架共存 → 列出选项请用户选择
- 测试超时 → 询问是否延长或终止
- 输出无法解析 → 返回原始输出，建议手动分析

---

## 用户选择处理

### 场景: 测试框架选择（多框架共存时）

```yaml
内容要素:
  - 检测到的框架列表
  - 各框架的测试文件数量和位置
  - 推荐选择（根据项目主要框架）

选项:
  选择框架N: 使用对应序号的框架运行测试
  全部运行: 依次运行所有框架的测试
  取消: 按 G6 状态重置协议执行
```

### 场景: 无法检测框架

```yaml
内容要素:
  - 检测结果: 无法自动识别测试框架
  - 请求用户提供测试命令

选项:
  用户输入测试命令: 使用用户提供的命令运行测试
  取消: 按 G6 状态重置协议执行
```

### 场景: 测试失败处理

```yaml
内容要素:
  - 测试结果摘要（通过/失败/跳过统计）
  - 失败测试列表（文件路径、行号、错误摘要）
  - 修复建议

选项:
  生成修复方案: 创建 plan/YYYYMMDDHHMM_fix-tests/ 方案包
  仅记录报告: 输出完整报告
  跳过: 不执行操作
```
