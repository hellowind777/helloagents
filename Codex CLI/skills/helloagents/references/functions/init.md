# ~init 命令 - 初始化知识库

本模块定义知识库初始化的执行规则。

---

## 命令说明

```yaml
命令: ~init
类型: 场景确认类
功能: 按照执行流程扫描代码库创建知识库
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~init 模式适配规则:
1. 本命令为独立工具命令，不受 WORKFLOW_MODE 影响
2. 评估深度: 轻量评估（无评分追问）
3. KB_CREATE_MODE=0 时需用户确认后执行
4. 知识库已存在时需用户确认重建或升级
5. 大型项目自动启用分批处理
</mode_adaptation>

---

## 执行流程

### 步骤1: 轻量评估

```yaml
执行规则: 按 G4 "需求评估规则"执行（轻量评估），按G3场景内容规则（需求评估场景）输出
```

### 步骤2: 扫描与检测

```yaml
知识库开关检查:
  IF KB_CREATE_MODE = 0 (OFF):
    按G3场景内容规则（确认场景）输出
    用户选择处理:
      继续执行: 继续执行下方流程
      取消: 按 G6 状态重置协议执行，流程终止
  ELSE (开关=1/2/3):
    直接继续执行下方流程（无需额外确认）
```

<kb_status_check>
知识库状态检测步骤:
1. 检查 helloagents/ 目录是否存在
2. 检查核心文件完整性
3. 对比当前结构与框架标准
4. 判定处理路径（全新创建/升级/补全/重建）
</kb_status_check>

```yaml
检测现有知识库状态:
  工具使用:
    - 文件查找: 检查 helloagents/ 目录是否存在
    - 文件读取: 检查知识库核心文件（INDEX.md, context.md, CHANGELOG.md, modules/_index.md）

  状态判定:
    不存在: 全新创建
    存在但结构与当前框架不匹配: 建议升级
    存在但不完整: 补全缺失文件
    存在且完整: 询问是否重建

  检测到结构不匹配时:
    按G3场景内容规则（确认场景）输出
    用户选择处理:
      升级: 转发到 references/functions/upgrade.md
      重建: 继续执行步骤3
      取消: 按 G6 状态重置协议执行

  重建确认（知识库已存在且完整时）:
    按G3场景内容规则（确认场景）输出
```

<techstack_detection>
技术栈识别步骤:
1. 扫描根目录配置文件（package.json, pyproject.toml, pom.xml等）
2. 分析源代码文件扩展名分布
3. 检查框架特征文件（如 next.config.js, vite.config.ts）
4. 综合判断主要语言、框架、包管理器
5. 如无法确定，标注"未识别"并建议用户补充
</techstack_detection>

```yaml
扫描代码库:

工具使用:
  - 文件查找: 扫描项目源代码目录结构
  - 文件读取: 读取关键配置文件
  - 内容搜索: 识别模块、API、数据模型

技术栈识别策略（语言无关）:
  识别顺序:
    1. 扫描根目录的包管理/构建配置文件
    2. 分析源代码文件扩展名分布
    3. 检查常见框架特征文件
  识别优先级:
    1. 根目录配置文件（最可靠）
    2. 常见子目录（src/、lib/、app/）
    3. 文件扩展名统计（兜底）
  输出要求:
    - 记录到 context.md 的"技术上下文"章节
    - 包含: 语言、框架、包管理器、构建工具
    - 如无法确定，标注"未识别"并建议用户补充

提取信息:
  - 技术栈（语言、框架、依赖）
  - 模块结构（目录分析）
  - API接口（路由文件扫描）
  - 数据模型（模型文件扫描）
```

### 步骤3: 创建知识库文件

```yaml
目录创建规则: 按 G1 "目录/文件自动创建规则" 执行

读取 references/services/templates.md 获取模板，创建:
  根目录:
    - helloagents/INDEX.md（知识库入口）
    - helloagents/context.md（项目上下文）
    - helloagents/CHANGELOG.md（变更日志）

  modules目录:
    - helloagents/modules/_index.md（模块索引）
    - helloagents/modules/{module}.md（每个模块）

  归档目录:
    - helloagents/archive/_index.md（归档索引）
    - helloagents/plan/（空目录，待执行方案包）

大型项目处理:
  判定条件: 按 G9 "大型项目判定" 条件执行
  目录结构（模块数>30时）:
    - helloagents/modules/_index.md（全局索引）
    - helloagents/modules/core/（核心模块）
    - helloagents/modules/feature/（功能模块）
    - helloagents/modules/shared/（共享模块）
  处理方式:
    - 分批处理（每批≤20个模块）
    - 优先处理核心模块
    - 在总结中说明处理进度
```

### 步骤4: 后续操作

> 📌 规则引用: 验收标准见 G8 "~init 验收标准"

```yaml
验证项:
  完整性:
    - 核心文件存在且非空
    - 模块覆盖完整
  安全性:
    - 无敏感信息泄露（密钥、密码等）
  格式:
    - Markdown格式正确
    - Mermaid图表可渲染

完成后: 按G3场景内容规则（完成场景）输出初始化结果
执行: 按 G6 状态重置协议执行
```

---

## 不确定性处理

- 空项目（无源代码文件） → 按G3场景内容规则（错误场景）输出，建议确认目录
- 权限不足（无法创建目录） → 按G3场景内容规则（错误场景）输出，建议检查权限
- 扫描超时（大型项目） → 分批处理，输出进度提示
- 配置文件缺失（无法识别项目类型） → 询问用户提供技术栈信息

---

## 用户选择处理

### 场景: 知识库开关确认（KB_CREATE_MODE=0）

```yaml
内容要素:
  - 当前开关状态: KB_CREATE_MODE = 0 (OFF)
  - 行为说明: 知识库操作已关闭，~init 将忽略开关强制执行

选项:
  继续执行: 忽略开关，继续初始化知识库
  取消: 按 G6 状态重置协议执行
```

### 场景: 结构不匹配

```yaml
内容要素:
  - 检测结果: 知识库存在但结构与当前框架不匹配
  - 不匹配说明: 具体的结构差异描述

选项:
  升级: 转发到 references/functions/upgrade.md
  重建: 删除现有知识库，重新创建
  取消: 按 G6 状态重置协议执行
```

### 场景: 知识库重建确认

```yaml
内容要素:
  - 已存在说明: 知识库已存在且完整
  - 重建影响: 将删除现有内容并重新创建

选项:
  重建: 删除现有知识库，重新创建
  取消: 按 G6 状态重置协议执行
```
