# ~plan 命令 - 执行到方案设计

本模块定义规划命令的执行规则。

---

## 命令说明

```yaml
命令: ~plan [<需求描述>]
类型: 完整流程类
功能: 按照执行流程从需求评估执行到方案设计阶段后停止（不进入开发实施）
模式: WORKFLOW_MODE = AUTO_PLAN
```

---

## 执行模式适配

> 📌 规则引用: 按 G4 路由架构及 G5 执行模式规则执行

<mode_adaptation>
~plan 模式适配规则:
1. 本命令固定使用 AUTO_PLAN 模式
2. 评估深度: 完整评估（含评分追问）
3. 流程在方案设计完成后终止，不进入开发实施
4. 微调模式需特殊处理（建议直接执行或强制规划）
5. 静默模式下自动选择推荐方案
6. 各阶段自动按需调用子代理（按 G9/G10 规则）
</mode_adaptation>

---

## 执行流程

### 步骤1: 需求评估

```yaml
设置状态变量:
  - WORKFLOW_MODE = AUTO_PLAN
  - STAGE_ENTRY_MODE = NATURAL

执行规则: 按 G4 "需求评估规则"执行（完整评估+复杂度判定），按G3场景内容规则（需求评估/复杂度判定场景）输出
```

### 步骤2: 执行对应模式

```yaml
根据复杂度判定结果:
  微调模式: 按"微调模式处理"规则输出提示，建议直接执行
  轻量迭代/标准开发: 进入步骤3
```

### 步骤3: 项目分析（仅轻量迭代/标准开发）

```yaml
执行规则: 读取并执行 references/stages/analyze.md

静默模式: 不输出
交互模式: 输出阶段完成提示
```

### 步骤4: 方案设计

```yaml
执行规则: 读取并执行 references/stages/design.md

复杂任务: 静默模式下自动选择推荐方案
简单任务: 静默模式下自动确定方案

设置: CREATED_PACKAGE = 本次创建的方案包路径
```

### 步骤5: 后续操作

```yaml
执行规则: 按 G8 "流程级验收规则" 执行

验收内容:
  交付物验收:
    - 方案包状态: 已创建
    - 方案包验收: 通过/部分通过

  需求符合性:
    - 原始需求回顾
    - 方案覆盖范围

  问题汇总:
    - 方案包验收警告（如有）
    - 信息性记录

遗留方案包扫描:
  执行规则: 按 G6 "遗留方案包扫描" 执行
  扫描时机: 流程即将结束时
  显示条件: 检测到≥1个遗留方案包
  详细规则: 参考 references/services/package.md "遗留方案包处理"

完成后: 按G3场景内容规则（完成场景）输出规划命令结果（含验收报告）
执行: 按 G6 状态重置协议执行
流程终止（不进入开发实施）
```

---

## 微调模式处理

```yaml
触发条件: 复杂度判定为微调模式时

执行规则: 按G3场景内容规则（确认场景）输出，见"用户选择处理 - 微调模式处理"
```

---

## 不确定性处理

- 需求描述不完整 → 按 G4 需求评估追问循环处理
- 复杂度判定为微调 → 提示用户选择直接执行或强制规划
- 方案设计无法完成 → 输出已完成部分，标注待定项

---

## 用户选择处理

> 本章节定义 ~plan 命令需要用户确认的场景，供 G3 输出格式统一提取。

### 场景: 执行模式确认（需求评估完成后）

```yaml
触发条件: WORKFLOW_MODE = AUTO_PLAN（~plan命令触发）

内容要素: 按 G4 "复杂度判定确认"场景，额外包含:
  - 执行方式说明（静默执行 vs 交互执行的区别）
  - 预计影响范围

选项: 按 G4 "复杂度判定确认"场景（AUTO_FULL/AUTO_PLAN模式）

状态变更: 按 references/rules/state.md "模式切换协议"执行
```

### 场景: 微调模式处理

```yaml
触发条件: ~plan命令 + 复杂度判定为微调模式

内容要素:
  - 复杂度判定: 微调模式
  - 模式说明: 微调模式无需方案设计，~plan命令的目标是生成方案包
  - 操作选项说明

选项:
  直接执行:
    - 说明: 虽然~plan本意是生成方案包，但微调模式可直接执行
    - 设置: WORKFLOW_MODE = INTERACTIVE（切换为交互模式）
    - 设置: CURRENT_STAGE = TWEAK
    - 执行: 读取并执行 references/stages/tweak.md
    - 完成后: tweak.md 执行状态重置，~plan 流程结束
  强制规划:
    - 说明: 升级为轻量迭代，生成方案包
    - 设置: CURRENT_STAGE = ANALYZE
    - 执行: 读取并执行 references/stages/analyze.md → design.md
    - 完成后: 按 plan.md 步骤5流程级验收
  取消: 按 G6 状态重置协议执行

注意: ~plan命令的微调模式是特殊情况，因为微调不产生方案包
```

### 场景: 流程级验收完成

```yaml
内容要素:
  - 验收状态: 通过/部分通过/失败
  - 交付物摘要: 方案包路径和状态
  - 需求符合性: 方案覆盖范围
  - 问题汇总: 警告和信息性记录（如有）

输出格式: 按G3场景内容规则（完成场景）输出
```
